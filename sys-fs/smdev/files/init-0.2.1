#!/sbin/runscript

depend()
{
	provide dev
	need sysfs
}

start()
{
	ebegin "Starting smdev"
	# umount /dev if it is already mounted.
	# It may be leftover from initramfs mount --move
	umount /dev/pts /dev/shm /dev >/dev/null 2>&1
	if fstabinfo --quiet /dev ; then
		mount -n /dev
	else
		mount -n -t tmpfs -o "exec,nosuid,mode=0755,size=10M" smdev-tmpfs /dev
	fi

	# Create some basic nodes.
	[ ! -e /dev/console ]	&& mknod /dev/console c 5 1
	[ ! -e /dev/null ]		&& mknod /dev/null c 1 3
	[ ! -e /dev/tty ]		&& mknod /dev/tty c 5 0
	[ ! -e /dev/tty1 ]		&& mknod /dev/tty1 c 4 1
	[ ! -e /dev/urandom ]	&& mknod /dev/urandom c 1 9
	[ ! -e /dev/random ]	&& mknod /dev/random c 1 8
	[ ! -e /dev/zero ]		&& mknod /dev/zero c 1 5

	ln -snf /proc/self/fd /dev/fd
	ln -snf fd/0 /dev/stdin
	ln -snf fd/1 /dev/stdout
	ln -snf fd/2 /dev/stderr
	[ -e /proc/kcore ] && ln -snf /proc/kcore /dev/core

	mkdir -m 0755 /dev/pts /dev/shm /dev/mapper

	if [ -e /proc/sys/kernel/hotplug ] ; then
		ebegin "Setting up smdev as hotplug agent"
		echo /bin/smdev > /proc/sys/kernel/hotplug
		eend 0
	fi

	ebegin "smdev: loading kernel modules"
	env -i /bin/smdev -s
	# Load kernel modules
	find /sys -name 'modalias' -type f -exec cat '{}' + | sort -u | xargs modprobe -b -a 2>/dev/null
	eend 0

	ebegin "smdev: mounting /dev/pts"
	if ! fstabinfo --mount /dev/pts; then
		mount -n -t devpts -o noexec,nosuid,gid=5,mode=0620 devpts /dev/pts
	fi
	eend "$?"

	ebegin "smdev: mounting /dev/shm"
	if ! fstabinfo --mount /dev/shm; then
		mount -n -t tmpfs -o noexec,nosuid,nodev,mode=1777 shm-tmpfs /dev/shm
	fi
	eend "$?"
}

stop() {
	ebegin "Stopping smdev"
	[ -e /proc/sys/kernel/hotplug ] && echo '' >/proc/sys/kernel/hotplug
	eend 0
}
